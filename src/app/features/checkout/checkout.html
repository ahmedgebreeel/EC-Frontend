<main class="main">
  <!-- Page Title -->
  <div class="page-title light-background">
    <div class="container d-lg-flex justify-content-between align-items-center">
      <h1 class="mb-2 mb-lg-0">Checkout</h1>
      <nav class="breadcrumbs">
        <ol>
          <li><a routerLink="/home">Home</a></li>
          <li><a routerLink="/cart">Cart</a></li>
          <li class="current">Checkout</li>
        </ol>
      </nav>
    </div>
  </div>
  <!-- End Page Title -->

  <!-- Loading State -->
  @if (isLoading()) {
  <section class="checkout section">
    <div class="container">
      <div class="loading-container">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p>Loading checkout...</p>
      </div>
    </div>
  </section>
  } @else if (cartItems().length === 0) {
  <!-- Empty Cart -->
  <section class="checkout section">
    <div class="container">
      <div class="empty-cart-message">
        <i class="bi bi-cart-x"></i>
        <h3>Your cart is empty</h3>
        <p>Add some items to your cart before checkout.</p>
        <a routerLink="/products" class="btn btn-primary">Continue Shopping</a>
      </div>
    </div>
  </section>
  } @else {
  <!-- Checkout Section -->
  <section id="checkout" class="checkout section">
    <div class="container" data-aos="fade-up" data-aos-delay="100">
      <div class="row">
        <div class="col-lg-7">
          <!-- Checkout Form -->
          <div class="checkout-container" data-aos="fade-up">
            <form class="checkout-form" (ngSubmit)="placeOrder()">
              <!-- Shipping Address Selection -->
              <div class="checkout-section" id="shipping-address">
                <div class="section-header">
                  <div class="section-number">1</div>
                  <h3>Shipping Address</h3>
                </div>
                <div class="section-content">
                  @if (showNewAddressForm()) {
                  <div class="new-address-form" data-aos="fade-in">
                    <h4 class="mb-3 fs-6 text-uppercase text-secondary">New Address Details</h4>
                    <div class="row">
                      <!-- <div class="col-md-6 mb-3">
                        <label class="form-label">First Name</label>
                        <input type="text" class="form-control" [ngModel]="newAddress().firstName" name="firstName"
                          (ngModelChange)="updateAddressField('firstName', $event)" placeholder="John">
                      </div>

                      <div class="col-md-6 mb-3">
                        <label class="form-label">Last Name</label>
                        <input type="text" class="form-control" [ngModel]="newAddress().lastName" name="lastName"
                          (ngModelChange)="updateAddressField('lastName', $event)" placeholder="Doe">
                      </div> -->

                      <div class="col-12 mb-3">
                        <label class="form-label">Street Address</label>
                        <input
                          type="text"
                          class="form-control"
                          [ngModel]="newAddress().street"
                          name="street"
                          (ngModelChange)="updateAddressField('street', $event)"
                          placeholder="123 Main St"
                        />
                      </div>

                      <div class="col-md-6 mb-3">
                        <label class="form-label">City</label>
                        <input
                          type="text"
                          class="form-control"
                          [ngModel]="newAddress().city"
                          name="city"
                          (ngModelChange)="updateAddressField('city', $event)"
                          placeholder="Cairo"
                        />
                      </div>

                      <div class="col-md-6 mb-3">
                        <label class="form-label">Governorate / State</label>
                        <input
                          type="text"
                          class="form-control"
                          [ngModel]="newAddress().state"
                          name="state"
                          (ngModelChange)="updateAddressField('state', $event)"
                          placeholder="Cairo"
                        />
                      </div>

                      <div class="col-md-6 mb-3">
                        <label class="form-label">Zip Code</label>
                        <input
                          type="text"
                          class="form-control"
                          [ngModel]="newAddress().zipCode"
                          name="zipCode"
                          (ngModelChange)="updateAddressField('zipCode', $event)"
                          placeholder="11311"
                        />
                      </div>

                      <div class="col-md-6 mb-3">
                        <label class="form-label">Country</label>
                        <select
                          class="form-select"
                          [ngModel]="newAddress().country"
                          name="country"
                          (ngModelChange)="updateAddressField('country', $event)"
                        >
                          <option value="Egypt">Egypt</option>
                        </select>
                      </div>
                    </div>
                    <div class="d-flex gap-2 justify-content-end mt-2">
                      <button
                        type="button"
                        class="btn btn-outline-secondary"
                        (click)="cancelNewAddress()"
                      >
                        Cancel
                      </button>
                      <button
                        type="button"
                        class="btn btn-primary"
                        (click)="saveNewAddress()"
                        [disabled]="isSubmitting()"
                      >
                        @if(isSubmitting()) {
                        <span class="spinner-border spinner-border-sm me-2"></span> Saving... }
                        @else { Save Address }
                      </button>
                    </div>
                  </div>
                  } @else { @if (addresses().length === 0) {
                  <div class="no-addresses-message">
                    <i class="bi bi-geo-alt"></i>
                    <p>No saved addresses found.</p>
                    <button type="button" class="btn btn-primary" (click)="toggleNewAddressForm()">
                      Add New Address
                    </button>
                  </div>
                  } @else {
                  <div class="address-cards">
                    @for (address of addresses(); track address.id) {
                    <div
                      class="address-card"
                      [class.selected]="selectedAddressId() === address.id"
                      (click)="selectAddress(address.id)"
                    >
                      <div class="address-card-header">
                        <input
                          type="radio"
                          name="shippingAddress"
                          [id]="'address-' + address.id"
                          [checked]="selectedAddressId() === address.id"
                          (change)="selectAddress(address.id)"
                        />
                        <label [for]="'address-' + address.id" class="address-label">
                          {{ address.label || 'Address' }}
                        </label>
                      </div>
                      <div class="address-card-body">
                        <p class="address-name">{{ address.fullName }}</p>
                        <p class="address-street">{{ address.street }}</p>
                        @if (address.apartment) {
                        <p class="address-apartment">{{ address.apartment }}</p>
                        }
                        <p class="address-city">{{ address.city }}, {{ address.governorate }}</p>
                        <p class="address-country">Egypt</p>
                        @if (address.phoneNumber) {
                        <p class="address-phone">
                          <i class="bi bi-telephone"></i> {{ address.phoneNumber }}
                        </p>
                        }
                      </div>
                    </div>
                    }
                  </div>
                  <div class="mt-3">
                    <button
                      type="button"
                      class="btn btn-outline-primary w-100 py-2 fw-bold"
                      (click)="toggleNewAddressForm()"
                    >
                      <i class="bi bi-plus-circle me-2"></i> Add Another Address
                    </button>
                  </div>
                  } }
                </div>
              </div>

              <!-- Shipping Method -->
              <div class="checkout-section" id="shipping-method">
                <div class="section-header">
                  <div class="section-number">2</div>
                  <h3>Shipping Method</h3>
                </div>
                <div class="section-content">
                  <div class="shipping-options">
                    <div
                      class="shipping-option"
                      [class.selected]="selectedShippingMethod() === ShippingMethod.Standard"
                      (click)="selectShippingMethod(ShippingMethod.Standard)"
                    >
                      <input
                        type="radio"
                        name="shippingMethod"
                        id="standard-shipping"
                        [checked]="selectedShippingMethod() === ShippingMethod.Standard"
                        (change)="selectShippingMethod(ShippingMethod.Standard)"
                      />
                      <label for="standard-shipping" class="shipping-label">
                        <div class="shipping-info">
                          <span class="shipping-icon"><i class="bi bi-truck"></i></span>
                          <div class="shipping-details">
                            <span class="shipping-name">Standard Delivery</span>
                            <span class="shipping-time">3-5 business days</span>
                          </div>
                        </div>
                        <span class="shipping-price">150 EGP</span>
                      </label>
                    </div>

                    <div
                      class="shipping-option"
                      [class.selected]="selectedShippingMethod() === ShippingMethod.Express"
                      (click)="selectShippingMethod(ShippingMethod.Express)"
                    >
                      <input
                        type="radio"
                        name="shippingMethod"
                        id="express-shipping"
                        [checked]="selectedShippingMethod() === ShippingMethod.Express"
                        (change)="selectShippingMethod(ShippingMethod.Express)"
                      />
                      <label for="express-shipping" class="shipping-label">
                        <div class="shipping-info">
                          <span class="shipping-icon"><i class="bi bi-lightning"></i></span>
                          <div class="shipping-details">
                            <span class="shipping-name">Express Delivery</span>
                            <span class="shipping-time">1-2 business days</span>
                          </div>
                        </div>
                        <span class="shipping-price">250 EGP</span>
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Payment Method -->
              <div class="checkout-section" id="payment-method">
                <div class="section-header">
                  <div class="section-number">3</div>
                  <h3>Payment Method</h3>
                </div>
                <div class="section-content">
                  <div class="payment-options">
                    <div
                      class="payment-option"
                      [class.selected]="selectedPaymentMethod() === PaymentMethod.CreditCard"
                      (click)="selectPaymentMethod(PaymentMethod.CreditCard)"
                    >
                      <input
                        type="radio"
                        name="paymentMethod"
                        id="credit-card"
                        [checked]="selectedPaymentMethod() === PaymentMethod.CreditCard"
                        (change)="selectPaymentMethod(PaymentMethod.CreditCard)"
                      />
                      <label for="credit-card" class="payment-label">
                        <div class="payment-info">
                          <span class="payment-icon"><i class="bi bi-credit-card"></i></span>
                          <div class="payment-details">
                            <span class="payment-name">Credit / Debit Card</span>
                            <span class="payment-desc">Pay securely with your card</span>
                          </div>
                        </div>
                      </label>
                    </div>

                    <div
                      class="payment-option"
                      [class.selected]="selectedPaymentMethod() === PaymentMethod.CashOnDelivery"
                      (click)="selectPaymentMethod(PaymentMethod.CashOnDelivery)"
                    >
                      <input
                        type="radio"
                        name="paymentMethod"
                        id="cash-on-delivery"
                        [checked]="selectedPaymentMethod() === PaymentMethod.CashOnDelivery"
                        (change)="selectPaymentMethod(PaymentMethod.CashOnDelivery)"
                      />
                      <label for="cash-on-delivery" class="payment-label">
                        <div class="payment-info">
                          <span class="payment-icon"><i class="bi bi-cash-coin"></i></span>
                          <div class="payment-details">
                            <span class="payment-name">Cash on Delivery</span>
                            <span class="payment-desc">Pay when you receive your order</span>
                          </div>
                        </div>
                      </label>
                    </div>
                  </div>

                  <!-- Credit Card Details (shown when credit card is selected) -->
                  @if (selectedPaymentMethod() === PaymentMethod.CreditCard) {
                  <div class="credit-card-details d-flex flex-column align-items-center " data-aos="fade-in">
                    <button type="button" class="btn btn-dark mb-3"
                     (click)="procceedToPayment()"
                     [disabled]="!canPlaceOrder()">
                      <i class="bi bi-lock-fill me-2"></i>
                      Pay with Stripe
                    </button>
                    <small class="text-muted d-block mt-2 text-center">
                      You will be redirected to Stripe to complete your payment securely.
                    </small>

                    <!-- <div class="form-group mb-3">
                      <label for="card-number" class="form-label">Card Number</label>
                      <div class="card-number-wrapper">
                        <input type="text" class="form-control" [class.is-invalid]="cardErrors().number"
                          name="card-number" id="card-number" placeholder="0000 0000 0000 0000" maxlength="19"
                          [ngModel]="cardNumber()" (ngModelChange)="cardNumber.set($event)">
                        <div class="card-icons">
                          <i class="bi bi-credit-card-2-front"></i>
                        </div>
                        @if (cardErrors().number) {
                        <div class="invalid-feedback d-block">{{ cardErrors().number }}</div>
                        }
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6 form-group mb-3">
                        <label for="expiry" class="form-label">Expiration Date</label>
                        <input type="text" class="form-control" [class.is-invalid]="cardErrors().expiry" name="expiry"
                          id="expiry" placeholder="MM/YY" maxlength="5" [ngModel]="cardExpiry()"
                          (ngModelChange)="cardExpiry.set($event)">
                        @if (cardErrors().expiry) {
                        <div class="invalid-feedback d-block">{{ cardErrors().expiry }}</div>
                        }
                      </div>
                      <div class="col-md-6 form-group mb-3">
                        <label for="cvv" class="form-label">CVV</label>
                        <div class="cvv-wrapper">
                          <input type="text" class="form-control" [class.is-invalid]="cardErrors().cvv" name="cvv"
                            id="cvv" placeholder="123" maxlength="4" [ngModel]="cardCvv()"
                            (ngModelChange)="cardCvv.set($event)">
                          <span class="cvv-hint" title="3-4 digit code on the back of your card">
                            <i class="bi bi-question-circle"></i>
                          </span>
                          @if (cardErrors().cvv) {
                          <div class="invalid-feedback d-block">{{ cardErrors().cvv }}</div>
                          }
                        </div>
                      </div>
                    </div>
                    <div class="form-group mb-3">
                      <label for="card-name" class="form-label">Name on Card</label>
                      <input type="text" class="form-control" [class.is-invalid]="cardErrors().name" name="card-name"
                        id="card-name" placeholder="Your Name" [ngModel]="cardName()"
                        (ngModelChange)="cardName.set($event)">
                      @if (cardErrors().name) {
                      <div class="invalid-feedback d-block">{{ cardErrors().name }}</div>
                      }
                    </div> -->
                  </div>
                  }
                </div>
              </div>

              <!-- Review & Place Order -->
              <div class="checkout-section" id="order-review">
                <div class="section-header">
                  <div class="section-number">4</div>
                  <h3>Review &amp; Place Order</h3>
                </div>
                <div class="section-content">
                  <div class="form-check terms-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="terms"
                      name="terms"
                      [checked]="termsAccepted()"
                      (change)="termsAccepted.set($any($event.target).checked)"
                    />
                    <label class="form-check-label" for="terms">
                      I agree to the <a routerLink="/tos">Terms and Conditions</a> and
                      <a routerLink="/privacy">Privacy Policy</a>
                    </label>
                  </div>
                  <div class="place-order-container">
                    <button
                      type="submit"
                      class="btn btn-primary place-order-btn"
                      [disabled]="!canPlaceOrder()"
                    >
                      @if (isSubmitting()) {
                      <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                      <span class="btn-text">Processing...</span>
                      } @else {
                      <span class="btn-text">Place Order</span>
                      <span class="btn-price">{{ totalAmount() | number : '1.2-2' }} EGP</span>
                      }
                    </button>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>

        <div class="col-lg-5">
          <!-- Order Summary -->
          <div class="order-summary" data-aos="fade-left" data-aos-delay="200">
            <div class="order-summary-header">
              <h3>Order Summary</h3>
              <span class="item-count"
                >{{ itemCount() }} {{ itemCount() === 1 ? 'Item' : 'Items' }}</span
              >
            </div>

            <div class="order-summary-content">
              <div class="order-items">
                @for (item of cartItems(); track item.id) {
                <div class="order-item">
                  <div class="order-item-image">
                    <img
                      [src]="item.productImageUrl"
                      [alt]="item.productName"
                      class="img-fluid"
                      loading="lazy"
                    />
                    <span class="item-quantity-badge">{{ item.quantity }}</span>
                  </div>
                  <div class="order-item-details">
                    <h4>{{ item.productName }}</h4>
                    <div class="order-item-price">
                      <span class="price">{{ item.price | number : '1.2-2' }} EGP</span>
                    </div>
                  </div>
                  <div class="order-item-total">{{ item.total | number : '1.2-2' }} EGP</div>
                </div>
                }
              </div>

              <div class="order-totals">
                <div class="order-subtotal d-flex justify-content-between">
                  <span>Subtotal</span>
                  <span>{{ subtotal() | number : '1.2-2' }} EGP</span>
                </div>
                <div class="order-shipping d-flex justify-content-between">
                  <span>Shipping</span>
                  <span>{{ shippingFees() | number : '1.2-2' }} EGP</span>
                </div>
                <div class="order-tax d-flex justify-content-between">
                  <span>Tax (14%)</span>
                  <span>{{ taxes() | number : '1.2-2' }} EGP</span>
                </div>
                <div class="order-total d-flex justify-content-between">
                  <span>Total</span>
                  <span>{{ totalAmount() | number : '1.2-2' }} EGP</span>
                </div>
              </div>

              <div class="secure-checkout">
                <div class="secure-checkout-header">
                  <i class="bi bi-shield-lock"></i>
                  <span>Secure Checkout</span>
                </div>
                <p class="secure-text">Your payment information is encrypted and secure.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- /Checkout Section -->
  }
</main>
