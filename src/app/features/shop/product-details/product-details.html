<main class="main">

  <!-- Page Title -->
  <div class="page-title light-background">
    <div class="container d-lg-flex justify-content-between align-items-center">
      <h1 class="mb-2 mb-lg-0">Product Details</h1>
      <nav class="breadcrumbs">
        <ol>
          <li><a routerLink="/home">Home</a></li>
          <li class="current">Product Details</li>
        </ol>
      </nav>
    </div>
  </div><!-- End Page Title -->

  <!-- Product Details Section -->
  <section id="product-details" class="product-details section">

    <div class="container" data-aos="fade-up" data-aos-delay="100">

      <div class="row g-4">
        <!-- Product Gallery -->
        <!-- Product Gallery -->
        <div class="col-lg-7" data-aos="zoom-in" data-aos-delay="150">
          <div class="product-gallery">
            <div class="main-showcase">
              <div class="image-zoom-container">
                @if(mainImage() && mainImage().imageUrl){
                <img [src]="mainImage().imageUrl" alt="Product Main" class="img-fluid main-product-image drift-zoom"
                  id="main-product-image">
                }
                <div class="image-navigation">
                  <button class="nav-arrow prev-image image-nav-btn prev-image" type="button" (click)="prevImage()">
                    <i class="bi bi-chevron-left"></i>
                  </button>
                  <button class="nav-arrow next-image image-nav-btn next-image" type="button" (click)="nextImage()">
                    <i class="bi bi-chevron-right"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="thumbnail-grid">
              @if(productData()){
              @for(img of productData()!.images; track $index){
              <div class="thumbnail-wrapper thumbnail-item {{$index === activeImage()?'active':''}}"
                (click)="selectImage($index)">
                <img [src]="img.imageUrl" [alt]="'View ' + ($index + 1)" class="img-fluid">
              </div>
              }
              }
            </div>
          </div>
        </div>

        <!-- Product Details -->
        <div class="col-lg-5" data-aos="fade-left" data-aos-delay="200">
          <div class="product-details">
            <div class="product-badge-container">
              @if(productData()){
              <a class="brand-badge" routerLink="/products" [queryParams]="{brandIds: productData()!.brandId}"
                [title]="'View all ' + productData()!.brandName + ' products'">
                <span class="brand-label">Brand</span>
                <span class="brand-name">{{productData()!.brandName}}</span>
              </a>
              }
              <div class="rating-group">
                <div class="stars">
                  @for(star of getStarsArray(productData()?.averageRating ?? 0); track $index) {
                  <i class="bi" [class.bi-star-fill]="star === 'full'" [class.bi-star-half]="star === 'half'"
                    [class.bi-star]="star === 'empty'"></i>
                  }
                </div>
                <span class="review-text">({{productData()?.reviewsCount ?? 0}} reviews)</span>
              </div>
            </div>

            <h1 class="product-name">{{productData()?.name}}</h1>

            <div class="pricing-section">
              <div class="price-display">
                <span class="price">
                  {{productData()?.price | number : '1.2-2'}}<span class="currency-suffix">EGP</span>
                </span>
              </div>
            </div>

            <div class="product-description">
              @if(productData()?.overviewDescription) {
              <p>{{productData()?.overviewDescription}}</p>
              } @else {
              <p class="text-muted fst-italic"><small>No description available for this product.</small></p>
              }
            </div>

            <div class="availability-status"
              [class.is-out-of-stock]="!productData() || productData()!.stockQuantity <= 0">
              @if(productData() && productData()!.stockQuantity > 0){
              <div class="stock-indicator">
                <i class="bi bi-check-circle-fill"></i>
                <span class="stock-text">In Stock</span>
              </div>
              <div class="quantity-left">Only {{productData()!.stockQuantity}} items remaining</div>
              } @else {
              <div class="stock-indicator out-of-stock" style="color: #6c757d !important;">
                <i class="bi bi-x-circle-fill"></i>
                <span class="stock-text">Out of Stock</span>
              </div>
              }
            </div>

            <!-- Product Variants - HIDDEN UNTIL IMPLEMENTED
            <div class="variant-section">
              <div class="size-selection">
                <label class="variant-label">Select Size:</label>
                <div class="size-grid">
                  @for (size of sizes(); track $index) {
                  <button class="size-btn" [class.active]="selectedSize() === size.name"
                    [class.disabled]="!size.available" [disabled]="!size.available" (click)="selectSize(size.name)">
                    {{size.name}}
                  </button>
                  }
                </div>
                @if(selectedSize()) {
                <div class="selected-variant">Selected: <span>{{selectedSize()}}</span></div>
                }
              </div>
            </div>
            -->

            <!-- Purchase Options -->
            <div class="purchase-section">
              <div class="quantity-control">
                <label class="control-label">Quantity:</label>
                <div class="quantity-input-group">
                  <div class="quantity-selector" [class.shake]="isShaking()">
                    <button class="quantity-btn decrease" (click)="decreaseQty()" type="button">
                      <i class="bi bi-dash"></i>
                    </button>
                    <input type="number" class="quantity-input" id="quantity" value={{quantity}} min="0"
                      [max]="maxStock" readonly>
                    <button class="quantity-btn increase" (click)="increaseQty()" type="button">
                      <i class="bi bi-plus"></i>
                    </button>
                  </div>
                </div>
              </div>

              <div class="action-buttons">
                <button class="btn primary-action" (click)="addToCart()" [disabled]="maxStock <= 0">
                  <i class="bi bi-bag-plus"></i>
                  Add to Cart
                </button>
                <button class="btn secondary-action" [disabled]="maxStock <= 0">
                  <i class="bi bi-lightning"></i>
                  Buy Now
                </button>
                <button class="btn icon-action" [class.wishlisted]="isWishlisted()"
                  [title]="isWishlisted() ? 'Remove from Wishlist' : 'Add to Wishlist'" (click)="toggleWishlist()">
                  <i class="bi" [class.bi-heart]="!isWishlisted()" [class.bi-heart-fill]="isWishlisted()"></i>
                </button>
              </div>
            </div>

            <!-- Benefits List -->
            <div class="benefits-list">
              <div class="benefit-item">
                <i class="bi bi-truck"></i>
                <span>Free delivery on orders over 1000 EGP</span>
              </div>
              <div class="benefit-item">
                <i class="bi bi-arrow-clockwise"></i>
                <span>45-day hassle-free returns</span>
              </div>
              <div class="benefit-item">
                <i class="bi bi-shield-check"></i>
                <span>3-year manufacturer warranty</span>
              </div>
              <div class="benefit-item">
                <i class="bi bi-headset"></i>
                <span>24/7 customer support available</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Information Tabs -->
      <div class="row mt-5" data-aos="fade-up" data-aos-delay="300">
        <div class="col-12">
          <div class="info-tabs-container">
            <nav class="tabs-navigation nav">
              <button class="nav-link active" data-bs-toggle="tab"
                data-bs-target="#ecommerce-product-details-5-overview" type="button">Overview</button>
              <button class="nav-link" data-bs-toggle="tab"
                data-bs-target="#ecommerce-product-details-5-customer-reviews" type="button"
                (click)="loadReviews()">Reviews ({{productData()?.reviewsCount ?? 0}})</button>
            </nav>

            <div class="tab-content">
              <!-- Overview Tab -->
              <div class="tab-pane fade show active" id="ecommerce-product-details-5-overview">
                <div class="overview-content">
                  <div class="row g-4">
                    <div class="col-lg-8">
                      <div class="content-section">
                        @if(productData()?.overviewHeadline) {
                        <h3 class="overview-headline">{{productData()!.overviewHeadline}}</h3>
                        }
                        <p class="overview-description">{{productData()?.overviewDescription}}</p>


                        @if(productData()?.careInstructions && productData()!.careInstructions.length > 0) {
                        <h4 class="mt-4 mb-3">Material & Care</h4>
                        <div class="material-care-grid">
                          @for(instruction of productData()!.careInstructions; track $index) {
                          <div class="care-item care-instruction-item">
                            <i class="bi {{getCareInfo(instruction).icon}}"></i>
                            <span class="care-label">{{getCareInfo(instruction).label}}</span>
                          </div>
                          }
                        </div>
                        }

                        @if(productData()?.features && productData()!.features.length > 0) {
                        <h4 class="mt-4 mb-3">Key Features</h4>
                        <ul class="features-list product-features-list">
                          @for(feature of productData()!.features; track $index) {
                          <li class="feature-item"><i class="bi bi-check2-circle"></i> {{feature}}</li>
                          }
                        </ul>
                        }
                      </div>
                    </div>

                    <div class="col-lg-4">
                      <div class="size-fit-container">
                        @if(productData()?.attributes && productData()!.attributes.length > 0) {
                        <div class="size-fit-section product-attributes-section mb-4">
                          <h4>Size & Fit</h4>
                          <ul class="fit-details attributes-list">
                            @for(attr of productData()!.attributes; track $index) {
                            <li class="attribute-item"><strong class="attribute-key">{{attr.key}}:</strong> <span
                                class="attribute-value">{{attr.value}}</span></li>
                            }
                          </ul>
                        </div>
                        }

                        <div class="composition-section product-composition-section">
                          <h4>Composition</h4>
                          <p class="composition-text product-composition-text">{{productData()?.compositionText}}</p>
                          @if(productData()?.isSustainable) {
                          <div class="fabric-badge sustainability-badge">
                            <i class="bi bi-recycle"></i> Sustainable Material
                          </div>
                          }
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Reviews Tab -->
              <div class="tab-pane fade" id="ecommerce-product-details-5-customer-reviews">
                <div class="reviews-content">
                  <div class="reviews-header">
                    <div class="rating-overview">
                      <div class="average-score">
                        <div class="score-display">{{productData()?.averageRating | number:'1.1-1'}}</div>
                        <div class="score-stars">
                          @for(star of getStarsArray(productData()?.averageRating ?? 0); track $index) {
                          <i class="bi" [class.bi-star-fill]="star === 'full'" [class.bi-star-half]="star === 'half'"
                            [class.bi-star]="star === 'empty'"></i>
                          }
                        </div>
                        <div class="total-reviews">{{productData()?.reviewsCount ?? 0}} customer reviews</div>
                      </div>

                      <div class="rating-distribution">
                        @for(starLevel of [5, 4, 3, 2, 1]; track starLevel) {
                        <div class="rating-row">
                          <span class="stars-label">{{starLevel}}★</span>
                          <div class="progress-container">
                            <div class="progress-fill"
                              [style.width.%]="(productData()?.ratingDistribution?.[starLevel] ?? 0) / (productData()?.reviewsCount || 1) * 100">
                            </div>
                          </div>
                          <span class="count-label">{{productData()?.ratingDistribution?.[starLevel] ?? 0}}</span>
                        </div>
                        }
                      </div>
                    </div>

                    <div class="write-review-cta">
                      @if(!showReviewForm()) {
                      <h4>Share Your Experience</h4>
                      <p>Help others make informed decisions</p>
                      <button class="btn review-btn" (click)="toggleReviewForm()">Write Review</button>
                      } @else {
                      <div class="review-form">
                        <div class="form-header">
                          <h4>Write Your Review</h4>
                          <button class="btn-close-form" (click)="toggleReviewForm()" type="button">
                            <i class="bi bi-x-lg"></i>
                          </button>
                        </div>

                        <div class="rating-selection">
                          <label class="form-label">Your Rating <span class="text-danger">*</span></label>
                          <div class="star-rating-input">
                            @for(i of [1, 2, 3, 4, 5]; track i) {
                            <i class="bi star-input" [class.bi-star-fill]="i <= (hoverRating() || newReviewRating())"
                              [class.bi-star]="i > (hoverRating() || newReviewRating())"
                              (mouseenter)="hoverRating.set(i)" (mouseleave)="hoverRating.set(0)"
                              (click)="setRating(i)"></i>
                            }
                            @if(newReviewRating() > 0) {
                            <span class="rating-text">{{newReviewRating()}} out of 5</span>
                            }
                          </div>
                        </div>

                        <div class="comment-section">
                          <label class="form-label" for="reviewComment">Your Review <span
                              class="text-muted">(Optional)</span></label>
                          <textarea class="form-control" id="reviewComment" rows="4" maxlength="200"
                            placeholder="Tell us what you think about this product..." [value]="newReviewComment()"
                            (input)="newReviewComment.set($any($event.target).value)"></textarea>
                          <div class="char-counter text-muted mt-1">{{newReviewComment().length}} / 200</div>
                        </div>

                        <div class="form-actions">
                          <button class="btn btn-outline-secondary" type="button" (click)="toggleReviewForm()"
                            [disabled]="submittingReview()">Cancel</button>
                          <button class="btn review-btn" type="button"
                            [disabled]="newReviewRating() === 0 || submittingReview()" (click)="submitReview()">
                            @if(submittingReview()) {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            Submitting...
                            } @else {
                            Submit Review
                            }
                          </button>
                        </div>
                      </div>
                      }
                      @if(showThankYou()) {
                      <div class="thank-you-message">
                        <i class="bi bi-check-circle-fill"></i>
                        <span>Thank you for your feedback!</span>
                      </div>
                      }
                    </div>
                  </div>

                  <div class="customer-reviews-list">
                    @if(reviewsLoading()) {
                    <div class="reviews-loading text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading reviews...</span>
                      </div>
                    </div>
                    } @else if(reviews().length === 0) {
                    <div class="no-reviews-state text-center py-5">
                      <i class="bi bi-chat-square-text" style="font-size: 3rem; color: #ccc;"></i>
                      <p class="mt-3 text-muted">No reviews yet for this product.</p>
                      <p class="text-muted">Be the first to share your experience!</p>
                    </div>
                    } @else {
                    @for(review of displayedReviews(); track review.id) {
                    <div class="review-card">
                      <div class="reviewer-profile">
                        @if(review.userAvatarUrl) {
                        <img [src]="review.userAvatarUrl" [alt]="review.userName" class="profile-pic">
                        } @else {
                        <div class="profile-pic profile-initials">{{getInitials(review.userName)}}</div>
                        }
                        <div class="profile-details">
                          <div class="customer-name">{{review.userName}}</div>
                          <div class="review-meta">
                            <div class="review-stars">
                              @for(i of [1, 2, 3, 4, 5]; track i) {
                              <i class="bi" [class.bi-star-fill]="i <= review.rating"
                                [class.bi-star]="i > review.rating"></i>
                              }
                            </div>
                            <span class="review-date">{{review.created | date:'mediumDate'}}@if(review.updated){ ·
                              Edited}</span>
                          </div>
                        </div>
                      </div>
                      <div class="review-text">
                        @if(review.comment) {
                        <p>{{review.comment}}</p>
                        } @else {
                        <p class="text-muted fst-italic">This user did not write a comment.</p>
                        }
                      </div>
                      <div class="review-actions">
                        @if(!helpfulClicked().has(review.id)) {
                        <button class="action-btn" (click)="markHelpful(review.id)"
                          [disabled]="processingHelpful().has(review.id)">
                          <i class="bi bi-hand-thumbs-up"></i> Helpful ({{review.helpfulCount}})
                        </button>
                        } @else {
                        <div class="helpful-badge">
                          <i class="bi bi-check-circle-fill"></i> Thanks for your feedback!
                        </div>
                        }
                      </div>
                    </div>
                    }
                    @if(reviews().length > 3 && !showAllReviews()) {
                    <div class="view-all-section">
                      <button class="btn btn-outline-primary view-all-btn" (click)="showAllReviews.set(true)">
                        View All {{reviews().length}} Reviews
                      </button>
                    </div>
                    }
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section><!-- /Product Details Section -->

</main>