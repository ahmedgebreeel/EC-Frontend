<main class="main">
  <!-- Page Title -->
  <div class="page-title light-background">
    <div class="container d-lg-flex justify-content-between align-items-center">
      <h1 class="mb-2 mb-lg-0">Products</h1>
      <nav class="breadcrumbs">
        <ol>
          <li><a routerLink="/home">Home</a></li>
          <li class="current">Products</li>
        </ol>
      </nav>
    </div>
  </div>
  <!-- End Page Title -->

  <div class="container">
    <div class="row">
      <div class="col-lg-4 sidebar">
        <div class="widgets-container">
          <!-- Product Categories Widget -->
          <div class="product-categories-widget widget-item">
            <h3 class="widget-title">Categories</h3>
            @if(allCategories().length > 0){
            <div class="category-list">
              @for(parent of categoryTree(); track parent.id){
              <div class="category-group">
                <div class="category-item parent-category">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" [id]="'cat-' + parent.id"
                      [checked]="selectedCategory() === parent.id" [class.child-selected]="hasChildSelected(parent)"
                      (change)="selectCategory(parent)" />
                    <label class="form-check-label" [for]="'cat-' + parent.id" [title]="parent.description">
                      {{ parent.name }}
                    </label>
                  </div>
                  @if(parent.subcategories.length > 0){
                  <button class="btn btn-link btn-sm category-expand p-0" type="button" data-bs-toggle="collapse"
                    [attr.data-bs-target]="'#subcats-' + parent.id" aria-expanded="false">
                    <i class="bi bi-chevron-down"></i>
                  </button>
                  }
                </div>
                @if(parent.subcategories.length > 0){
                <div class="collapse subcategory-list" [id]="'subcats-' + parent.id">
                  @for(child of parent.subcategories; track child.id){
                  <div class="category-item-wrapper">
                    <div class="category-item subcategory">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" [id]="'cat-' + child.id"
                          [checked]="selectedCategory() === child.id" [class.child-selected]="hasChildSelected(child)"
                          (change)="selectCategory(child)" />
                        <label class="form-check-label" [for]="'cat-' + child.id" [title]="child.description">
                          {{ child.name }}
                        </label>
                      </div>
                      @if(child.subcategories.length > 0){
                      <button class="btn btn-link btn-sm category-expand p-0" type="button" data-bs-toggle="collapse"
                        [attr.data-bs-target]="'#subcats-' + child.id" aria-expanded="false">
                        <i class="bi bi-chevron-down"></i>
                      </button>
                      }
                    </div>
                    @if(child.subcategories.length > 0){
                    <div class="collapse subcategory-list level-3" [id]="'subcats-' + child.id">
                      @for(grandchild of child.subcategories; track grandchild.id){
                      <div class="category-item subcategory">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" [id]="'cat-' + grandchild.id"
                            [checked]="selectedCategory() === grandchild.id" (change)="selectCategory(grandchild)" />
                          <label class="form-check-label" [for]="'cat-' + grandchild.id"
                            [title]="grandchild.description">
                            {{ grandchild.name }}
                          </label>
                        </div>
                      </div>
                      }
                    </div>
                    }
                  </div>
                  }
                </div>
                }
              </div>
              }
            </div>
            }
          </div>
          <!--/Product Categories Widget -->

          <!-- Pricing Range Widget -->
          <div class="pricing-range-widget widget-item">
            <h3 class="widget-title">Price Range</h3>

            <div class="price-range-container">
              <div class="current-range mb-3">
                <span class="min-price">{{ minValue }} EGP</span>
                <span class="max-price float-end">{{ maxValue >= 5000 ? '5000+' : maxValue }} EGP</span>
              </div>

              <div class="range-slider">
                <div class="slider-track"></div>
                <div class="slider-progress" [style.left.%]="minPercent" [style.width.%]="maxPercent - minPercent">
                </div>
                <input type="range" class="min-range" min="0" max="5000" value="0" step="50" [(ngModel)]="minValue"
                  (input)="updateMinSlider()" />
                <input type="range" class="max-range" min="0" max="5000" value="5000" step="50" [(ngModel)]="maxValue"
                  (input)="updateMaxSlider()" />
              </div>

              <div class="filter-actions mt-3">
                <button type="button" (click)="priceFilter()" class="btn btn-sm btn-primary w-100">
                  Apply Filter
                </button>
              </div>
            </div>
          </div>
          <!--/Pricing Range Widget -->

          <!-- Brand Filter Widget -->
          <div class="brand-filter-widget widget-item">
            <h3 class="widget-title">Filter by Brand</h3>

            <div class="brand-filter-content">
              <div class="brand-search">
                <input type="text" class="form-control" placeholder="Search brands..."
                  (input)="brandSearch.set($event.target.value)">
                <i class="bi bi-search"></i>
              </div>

              <div class="brand-list">
                @for(brand of filteredBrands(); track brand.id) {
                <div class="brand-item">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" [id]="'brand-'+brand.id"
                      [checked]="pendingSelectedBrands().includes(brand.id)" (change)="toggleBrand(brand.id)">
                    <label class="form-check-label" [for]="'brand-'+brand.id">
                      {{brand.name}}
                      <span class="brand-count">({{brand.productsCount}})</span>
                    </label>
                  </div>
                </div>
                }
              </div>

              <div class="brand-actions">
                <button class="btn btn-sm btn-outline-primary" (click)="applyBrandFilter()">Apply Filter</button>
                <button class="btn btn-sm btn-link" (click)="pendingSelectedBrands.set([]); applyBrandFilter()">Clear
                  All</button>
              </div>
            </div>
          </div>
          <!--/Brand Filter Widget -->
        </div>
      </div>

      <div class="col-lg-8">
        <!-- Category Header Section -->
        <section id="category-header" class="category-header section">
          <div class="container" data-aos="fade-up">
            <!-- Filter and Sort Options -->
            <div class="filter-container mb-4" data-aos="fade-up" data-aos-delay="100">
              <div class="row g-3">
                <div class="col-12 col-lg-6">
                  <div class="filter-item search-form">
                    <div class="input-group">
                      <span class="input-group-text search-icon">
                        <i class="bi bi-search"></i>
                      </span>
                      <input type="text" class="form-control" id="productSearch" placeholder="Search for products..."
                        aria-label="Search for products" [value]="search()" (input)="search.set($event.target.value)" />
                    </div>
                  </div>
                </div>

                <div class="col col-lg-auto ms-lg-auto">
                  <div class="filter-item">
                    <div class="dropdown sort-dropdown">
                      <button class="filter-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-sort-alpha-down"></i>
                        <span>{{ selectedSort() }}</span>
                        <i class="bi bi-chevron-down"></i>
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" [class.active]="selectedSort() === 'Featured'"
                            (click)="setSort('featured', 'Featured')">Featured</a></li>
                        <li><a class="dropdown-item" [class.active]="selectedSort() === 'Price: Low to High'"
                            (click)="setSort('priceAsc', 'Price: Low to High')">Price: Low to High</a></li>
                        <li><a class="dropdown-item" [class.active]="selectedSort() === 'Price: High to Low'"
                            (click)="setSort('priceDesc', 'Price: High to Low')">Price: High to Low</a></li>
                        <li><a class="dropdown-item" [class.active]="selectedSort() === 'Newest Arrivals'"
                            (click)="setSort('newest', 'Newest Arrivals')">Newest Arrivals</a></li>
                      </ul>
                    </div>
                  </div>
                </div>

                <div class="col-auto">
                  <div class="filter-item d-flex justify-content-end">
                    <div class="btn-group view-toggle" role="group" aria-label="View toggle">
                      <button type="button" class="btn view-btn" [class.active]="viewType() === 'grid'"
                        (click)="setView('grid')" aria-label="Grid view">
                        <i class="bi bi-grid-3x3-gap-fill"></i>
                      </button>
                      <button type="button" class="btn view-btn" [class.active]="viewType() === 'list'"
                        (click)="setView('list')" aria-label="List view">
                        <i class="bi bi-list-ul"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              @if(activeFilters().length > 0){
              <div class="row mt-3">
                <div class="col-12" data-aos="fade-up" data-aos-delay="200">
                  <div class="active-filters">
                    <span class="active-filter-label">Active Filters:</span>
                    <div class="filter-tags">
                      @for(filter of activeFilters(); track $index){
                      <span class="filter-tag">
                        <span class="filter-type">{{ filter.label }}:</span> {{ filter.value }}
                        <button class="filter-remove" (click)="removeFilter(filter.type, filter.id)" type="button"
                          aria-label="Remove filter">
                          <i class="bi bi-x"></i>
                        </button>
                      </span>
                      }
                    </div>
                    <button class="clear-all-btn" (click)="clearAllFilters()" type="button">Clear All</button>
                  </div>
                </div>
              </div>
              }
            </div>
          </div>
        </section>
        <!-- /Category Header Section -->

        <!-- Category Product List Section -->
        <section [ngClass]="viewType()" id="category-product-list" class="category-product-list section">
          <div class="container products-container" data-aos="fade-up" data-aos-delay="100">
            <!-- Loading Overlay -->
            <div class="products-loading-overlay" [class.active]="loadingService.isLoading()">
              <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>

            <!-- Products Grid -->
            <div class="row g-4 products-grid" [class.loading]="loadingService.isLoading()">
              @if(allProducts()){
              @for(product of allProducts() | paginate : { itemsPerPage:
              pageSize, currentPage: pageIndex(), totalItems: totalPages()}; track $index) {

              <div [ngClass]="viewType() === 'grid' ? 'col-6 col-xl-4' : 'col-12'">
                <app-product-card [viewType]="viewType()" [productData]="product"></app-product-card>
              </div>

              }}
            </div>
          </div>
        </section>
        <!-- /Category Product List Section -->

        <!-- Category Pagination Section -->
        <div class="pagination-wrapper">
          <div class="pagination">
            <pagination-controls (pageChange)="onPageChange($event)"></pagination-controls>
          </div>
        </div>

        <!-- /Category Pagination Section -->
      </div>
    </div>
  </div>
</main>