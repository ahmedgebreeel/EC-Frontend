<div class="section-header">
    <h2>My Reviews</h2>
    <div class="header-actions">
        <div class="dropdown">
            <button class="filter-btn" data-bs-toggle="dropdown">
                <i class="bi bi-funnel"></i>
                <span>{{filterLabel()}}</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" (click)="setFilter('all', 'All Reviews')">All Reviews</a></li>
                <li><a class="dropdown-item" (click)="setFilter('5', '5 Stars')">5 Stars</a></li>
                <li><a class="dropdown-item" (click)="setFilter('4', '4 Stars')">4 Stars</a></li>
                <li><a class="dropdown-item" (click)="setFilter('3&below', '3 & Below')">3 & Below</a></li>
            </ul>
        </div>
    </div>
</div>

<div class="reviews-grid">
    @if(reviewsLoading()) {
    <!-- Loading Skeleton -->
    @for(item of [1, 2, 3]; track item) {
    <div class="review-card skeleton-card">
        <div class="review-header" style="opacity: 0.5;">
            <div class="skeleton-image"></div>
            <div class="review-meta w-100">
                <div class="skeleton-title" style="width: 60%; height: 20px; margin-bottom: 8px;"></div>
                <div class="skeleton-text" style="width: 40%; height: 16px;"></div>
            </div>
        </div>
        <div class="review-content mt-3">
            <div class="skeleton-text" style="width: 100%; height: 16px; margin-bottom: 8px;"></div>
            <div class="skeleton-text" style="width: 80%; height: 16px;"></div>
        </div>
    </div>
    }
    } @else if(reviews().length === 0) {
    <div class="empty-state text-center py-5">
        <i class="bi bi-chat-square-text" style="font-size: 3rem; color: #ccc;"></i>
        <p class="mt-3 text-muted">You haven't written any reviews yet.</p>
    </div>
    } @else {
    @for(review of reviews(); track review.id) {
    <div class="review-card">
        @if(editingReviewId() === review.id) {
        <div class="edit-review-form">
            <h4 class="mb-3">Edit Review</h4>

            <div class="rating-input mb-3">
                <label class="form-label d-block">Your Rating</label>
                <div class="stars">
                    @for(star of [1, 2, 3, 4, 5]; track star) {
                    <i class="bi" [class.bi-star-fill]="star <= (editHoverRating() || editRating())"
                        [class.bi-star]="star > (editHoverRating() || editRating())"
                        (mouseenter)="editHoverRating.set(star)" (mouseleave)="editHoverRating.set(0)"
                        (click)="setEditRating(star)"
                        style="cursor: pointer; color: #ffc107; font-size: 1.5rem; margin-right: 5px;">
                    </i>
                    }
                    <span class="rating-text">{{editRating()}} out of 5</span>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Review</label>
                <textarea class="form-control" rows="3" [value]="editComment()"
                    (input)="editComment.set($any($event.target).value)" maxlength="200"
                    placeholder="Write your review here..."></textarea>
                <div class="text-end text-muted small mt-1">
                    {{editComment().length}} / 200
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-outline-secondary" (click)="cancelEdit()">Cancel</button>
                <button class="btn btn-primary" (click)="saveEdit()" [disabled]="editRating() === 0 || savingReview()">
                    @if(savingReview()) {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Saving...
                    } @else {
                    Save Changes
                    }
                </button>
            </div>
        </div>
        } @else {
        <div class="review-header">
            <img [src]="review.productThumbnailUrl" [alt]="review.productName" class="product-image" loading="lazy">
            <div class="review-meta">
                <h4>{{review.productName}}</h4>
                <div class="rating">
                    @for(i of [1, 2, 3, 4, 5]; track i) {
                    <i class="bi" [class.bi-star-fill]="i <= review.rating" [class.bi-star]="i > review.rating"></i>
                    }
                    <span>({{review.rating}}.0)</span>
                </div>
                <div class="review-date">
                    Reviewed on {{review.created | date:'mediumDate'}}@if(review.updated){ Â· Edited on {{review.updated
                    | date:'mediumDate'}}}
                </div>
            </div>
        </div>
        <div class="review-content">
            @if(review.comment) {
            <p>{{review.comment}}</p>
            } @else {
            <p class="text-muted fst-italic">You did not write a comment for this review.</p>
            }
        </div>
        <div class="review-footer">
            <span class="helpful-count"><i class="bi bi-hand-thumbs-up"></i> {{review.helpfulCount}}</span>
            <div class="review-actions">
                <button type="button" class="btn-edit" (click)="startEdit(review)"
                    [disabled]="deletingReviewId() === review.id">Edit Review</button>
                <button type="button" class="btn-delete" (click)="deleteReview(review.id)"
                    [disabled]="deletingReviewId() === review.id">
                    @if(deletingReviewId() === review.id) {
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    } @else {
                    Delete
                    }
                </button>
            </div>
        </div>
        }
    </div>
    }
    }
</div>